<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<features name="horizon" xmlns="http://karaf.apache.org/xmlns/features/v1.3.0" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://karaf.apache.org/xmlns/features/v1.3.0 http://karaf.apache.org/xmlns/features/v1.3.0">

    <repository>mvn:org.apache.aries.jax.rs/org.apache.aries.jax.rs.features/1.0.6/xml</repository>
    <repository>mvn:org.apache.cxf.karaf/apache-cxf/${cxf.version}/xml/features</repository>
    <repository>mvn:no.priv.bang.karaf/liquibase-core-karaf/${liquibaseVersion}/xml/features</repository>

    <feature name="guava" version="${guava.version}" description="Google :: Guava">
        <bundle dependency="true">mvn:com.google.guava/guava/${guava.version}</bundle>
        <bundle dependency="true">mvn:com.google.guava/failureaccess/1.0.1</bundle>
    </feature>

    <feature name="horizon-alarms" version="${project.version}">
        <feature>horizon-events</feature>
        <feature>horizon-db</feature>
        <feature>horizon-core-rest</feature>

        <feature version="${drools.version}">kie-drools</feature>

        <bundle>mvn:org.opennms.horizon.alarms/api/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.alarms/daemon/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.alarms/rest/${project.version}</bundle>
    </feature>

    <feature name="horizon-core" version="${project.version}">
        <feature>moxy</feature>
        <feature version="${spring.version}">spring</feature>
        <feature>guava</feature>

        <bundle>mvn:commons-io/commons-io/${commons.io.version}</bundle>
        <bundle dependency="true">mvn:org.apache.commons/commons-jexl/${jexl.version}</bundle>

        <bundle>mvn:org.opennms.horizon.core/identity/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.core/lib/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.core/xml/${project.version}</bundle>
    </feature>

    <feature name="horizon-core-rest" version="${project.version}">
        <feature>horizon-core</feature>

        <feature>http</feature>
        <feature>jetty</feature>
        <feature>cxf-jaxrs</feature>
        <feature>cxf-sse</feature>
        <bundle>mvn:org.apache.aries.component-dsl/org.apache.aries.component-dsl.component-dsl/1.2.2</bundle>
        <feature>aries-jax-rs-whiteboard</feature>
        <feature>aries-jax-rs-whiteboard-jackson</feature>
        <bundle>mvn:javax.annotation/javax.annotation-api/1.3.2</bundle>

<!--        Use the built-in JAAS provider - may not be necessary if we use JWTs-->
<!--        <feature>jaas-deployer</feature>-->
<!--        <bundle>mvn:org.opennms.horizon.core/jaas/${project.version}</bundle>-->
    </feature>

    <feature name="horizon-db-config" version="${project.version}" description="Default Configs for DB">
        <config name="org.opennms.netmgt.distributed.datasource">
            osgi.jdbc.driver.class=org.postgresql.Driver

            datasource.adminUrl=jdbc:postgresql://localhost:5432/template1
            datasource.adminDatabaseName=postgres
            datasource.adminUsername=postgres
            datasource.adminPassword=

            datasource.url=jdbc:postgresql://localhost:5432/opennms
            datasource.username=opennms
            datasource.password=
            datasource.databaseName=opennms
            datasource.initialize=true
        </config>
    </feature>

    <!-- WORKAROUND: the PooledDataSourceFactory service exported by pax-jdbc-pool-hikaricp for some reason -->
    <!--             fails the feature install unless we explicitly declare the capability.                 -->
    <feature name="pax-jdbc-pool-capability-workaround">
        <feature>pax-jdbc-pool-hikaricp</feature>

        <capability>
            osgi.service;effective:=active;objectClass=org.ops4j.pax.jdbc.pool.common.PooledDataSourceFactory
        </capability>
    </feature>

    <feature name="horizon-db" version="${project.version}" description="Horizon :: DB">
        <!--<feature prerequisite="true">horizon-db-config</feature>-->
        <feature>pax-jdbc-postgresql</feature>
        <feature>pax-jdbc-pool-capability-workaround</feature>

        <feature>horizon-events-api</feature>
        <feature>liquibase-core</feature>

        <bundle>mvn:org.opennms.horizon.db/dao-api/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.db/dao-impl/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.db/schema/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.db/schema-liquibase/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.db/model/${project.version}</bundle>

        <bundle>mvn:com.fasterxml.jackson.core/jackson-core/${jackson.version}</bundle>
        <bundle>mvn:com.fasterxml.jackson.core/jackson-annotations/${jackson.version}</bundle>
        <bundle>mvn:com.fasterxml.jackson.core/jackson-databind/${jackson.version}</bundle>

        <bundle dependency="true">mvn:commons-lang/commons-lang/${commons.lang.version}</bundle>

        <feature version="${hibernate.version}">hibernate</feature>
        <feature>jdbc</feature>
        <feature>jndi</feature>
        <feature>jpa</feature>
        <feature>transaction</feature>
    </feature>

    <feature name="horizon-events-api" version="${project.version}" description="Horizon :: Events :: API">
        <feature>horizon-ipc-api</feature>

        <bundle dependency="true">mvn:javax.validation/validation-api/${javax.validation.version}</bundle>
        <bundle>wrap:mvn:org.json/json/${json.version}$Export-Package=org.json</bundle>
        <bundle>mvn:org.opennms.horizon.snmp/api/${project.version}</bundle>

        <bundle>mvn:org.opennms.horizon.events/api/${project.version}</bundle>
    </feature>

    <feature name="horizon-events" version="${project.version}" description="Horizon :: Events">
        <feature>horizon-events-api</feature>
        <feature>horizon-db</feature>
        <feature>horizon-core-rest</feature>

        <bundle>mvn:org.opennms.horizon.events/dao/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.events/daemon/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.events/rest/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.events/shell/${project.version}</bundle>
    </feature>

    <feature name="horizon-grpc" version="${project.version}" description="Horizon :: gRPC">
        <feature>horizon-ipc-api</feature>

        <bundle>mvn:org.opennms.horizon.3rdparty/grpc/${project.version}</bundle>
        <bundle>mvn:com.google.protobuf/protobuf-java/${protobuf.version}</bundle>

        <bundle>mvn:org.opennms.horizon.ipc.grpc/client/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.ipc.grpc/common/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.ipc.grpc/server/${project.version}</bundle>
    </feature>

    <feature name="horizon-icmp" version="${project.version}" description="Horizon :: ICMP">
        <feature>java-native-access</feature>
        <feature>guava</feature>
        <feature>horizon-grpc</feature>

        <bundle>mvn:org.opennms.horizon.core/lib/${project.version}</bundle>
        <bundle>mvn:org.opennms.lib/org.opennms.lib.tracker/${opennms.tracker.version}</bundle>
        <bundle>mvn:org.opennms/jicmp-api/${jicmp.version}</bundle>
        <bundle>mvn:org.opennms/jicmp6-api/${jicmp.version}</bundle>

        <bundle>mvn:org.opennms.horizon.icmp/api/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.icmp/best/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.icmp/jna/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.icmp/jni/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.icmp/jni6/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.icmp/shell/${project.version}</bundle>

        <bundle>mvn:org.opennms.horizon.icmp/rpc-impl/${project.version}</bundle>
    </feature>

    <feature name="horizon-ipc-api" version="${project.version}">
        <feature>guava</feature>
        <feature>rate-limited-logger</feature>
        <feature>horizon-core</feature>
        <feature>horizon-tracing</feature>

        <bundle>mvn:io.dropwizard.metrics/metrics-core/${dropwizard.metrics.version}</bundle>

        <bundle>mvn:org.opennms.horizon.ipc/api/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.ipc/shell/${project.version}</bundle>
    </feature>

    <feature name="horizon-tracing" version="${project.version}" description="Horizon :: Tracing">
        <feature>horizon-core</feature>

        <bundle dependency="true">wrap:mvn:io.opentracing/opentracing-api/${opentracing.version}</bundle>
        <bundle dependency="true">wrap:mvn:io.opentracing/opentracing-noop/${opentracing.version}</bundle>
        <bundle dependency="true">wrap:mvn:io.opentracing/opentracing-util/${opentracing.version}</bundle>

        <bundle>mvn:org.opennms.horizon.3rdparty/jaeger/${project.version}</bundle>

        <bundle>mvn:org.opennms.horizon.core.tracing/api/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.core.tracing/jaeger/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.core.tracing/registry/${project.version}</bundle>
    </feature>

    <feature name="horizon-snmp" version="${project.version}" description="Horizon :: SNMP">
        <feature>horizon-grpc</feature>
        <feature>horizon-events</feature>

        <bundle dependency="true">mvn:commons-io/commons-io/${commons.io.version}</bundle>
        <bundle dependency="true">mvn:commons-lang/commons-lang/${commons.lang.version}</bundle>
        <bundle dependency="true">wrap:mvn:org.snmp4j/snmp4j/${snmp4j.version}</bundle>

        <bundle>mvn:org.opennms.horizon.snmp/api/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.snmp/rpc-impl/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.snmp/snmp4j/${project.version}</bundle>
        <bundle>mvn:org.opennms.horizon.snmp/shell/${project.version}</bundle>
    </feature>

    <feature name="java-native-access" version="${jna.version}" description="Java Native Access (JNA)">
        <bundle>mvn:net.java.dev.jna/jna/${jna.version}</bundle>
        <bundle>mvn:net.java.dev.jna/jna-platform/${jna.version}</bundle>
    </feature>

    <feature name="kie-drools" version="${drools.version}" description="KIE Drools">
        <!-- org.kie.api.KieServices -->
        <bundle>mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.xstream/1.4.8_1</bundle>
        <bundle>mvn:org.kie.soup/kie-soup-commons/7.31.0.Final</bundle>
        <bundle>mvn:org.kie.soup/kie-soup-project-datamodel-api/7.31.0.Final</bundle>
        <bundle>mvn:org.mvel/mvel2/2.2.4.Final</bundle>
        <bundle>mvn:org.kie.soup/kie-soup-project-datamodel-commons/7.31.0.Final</bundle>
        <bundle>mvn:org.kie.soup/kie-soup-maven-support/7.31.0.Final</bundle>
        <bundle>mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.antlr</bundle>
        <bundle>mvn:com.google.protobuf/protobuf-java/${protobuf.version}</bundle>
        <bundle>mvn:commons-codec/commons-codec/1.10</bundle>

        <!-- these next 5 have interdependent dependencies and cannot start as loaded -->
        <bundle>mvn:org.drools/drools-core/7.31.0.Final</bundle>
        <bundle>mvn:org.drools/drools-compiler/7.31.0.Final</bundle>
        <bundle>mvn:org.kie/kie-api/7.31.0.Final</bundle>
        <bundle>mvn:org.kie/kie-internal/7.31.0.Final</bundle>
        <bundle>mvn:org.drools/drools-core-reflective/7.31.0.Final</bundle>

        <bundle>mvn:org.drools/drools-core-dynamic/7.31.0.Final</bundle>
        <bundle>mvn:com.thoughtworks.xstream/xstream/1.4.18</bundle> <!-- this later version provides lambda loader dependency -->
        <!--  <bundle>mvn:org.kie/kie-osgi-integration/7.31.0.Final</bundle> -->
        <bundle>mvn:org.mvel/mvel2/2.4.4.Final</bundle>
        <bundle>wrap:mvn:org.eclipse.jdt.core.compiler/ecj/4.4.2$Bundle-SymbolicName=Eclipse-JDT-Compiler&amp;Bundle-Version=4.4.2</bundle>
        <bundle>wrap:mvn:org.codehaus.janino/janino/2.5.16$Bundle-SymbolicName=Codehaus-Janino&amp;Bundle-Version=2.5.16</bundle>
        <bundle>mvn:org.apache.geronimo.specs/geronimo-atinject_1.0_spec/1.0</bundle>
    </feature>

    <feature name="moxy" version="${eclipselink.version}" description="EclipseLink :: MOXy">
        <bundle>mvn:com.sun.mail/jakarta.mail/${jakarta.mail.version}</bundle>
        <bundle>mvn:org.eclipse.persistence/org.eclipse.persistence.moxy/${eclipselink.version}</bundle>
        <bundle>mvn:org.eclipse.persistence/org.eclipse.persistence.core/${eclipselink.version}</bundle>
        <bundle>mvn:org.eclipse.persistence/org.eclipse.persistence.asm/${eclipselink.version}</bundle>
        <bundle>mvn:org.eclipse.persistence/org.eclipse.persistence.antlr/${eclipselink.version}</bundle>
    </feature>

    <feature name="rate-limited-logger" version="${rateLimitedLoggerVersion}" description="Rate Limited Logger">
        <bundle>mvn:joda-time/joda-time/2.1</bundle>
        <bundle>wrap:mvn:com.swrve/rate-limited-logger/${rate.limitted.logger.version}</bundle>
    </feature>

    <!-- FIXME: Should we define this here, or pull it in? -->
    <feature name="spring" description="Spring support" version="${spring.version}">
        <bundle dependency="true" start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.aopalliance/1.0_6
        </bundle>
        <bundle start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.spring-core/${spring.version}
        </bundle>
        <bundle start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.spring-expression/${spring.version}
        </bundle>
        <bundle start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.spring-beans/${spring.version}
        </bundle>
        <bundle start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.spring-aop/${spring.version}
        </bundle>
        <bundle start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.spring-context/${spring.version}
        </bundle>
        <bundle start-level="30">
            mvn:org.apache.servicemix.bundles/org.apache.servicemix.bundles.spring-context-support/${spring.version}
        </bundle>
    </feature>

</features>